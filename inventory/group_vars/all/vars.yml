# REM: if you are looking for passwords or other variables
# that vary from dev to stage to prod, check the other subfolders

# setup vars
project:                      "catalyst-ansible"
version:                      "0.3.0"
login_user:                   "deploy"

# ssh vars
ssh_port: 22
# uncomment after first run (if not 22):
# ansible_ssh_port: "{{ ssh_port }}"

mode:                         "deploy" # dev || deploy

app_repo:                     "git@github.com:jhu-sheridan-libraries/blacklight-rails.git" #"https://github.com/jhu-sheridan-libraries/blacklight-rails"
app_branch:                   "ansibilize"
app_name:                     "catalyst"
app_user:                     "{{ app_name }}"
app_group:                    "{{ app_user }}"
base_deploy_dir:              "/opt"
deploy_dir:                   "{{ base_deploy_dir }}/{{ app_name }}"

# deploy keys vars
deploy_private_key:           "{{ vault_deploy_private_key }}"
deploy_public_key:            "{{ vault_deploy_public_key }}"
deploy_user:                  "{{ login_user }}"
deploy_key_name:              "catalyst_deploy_key"
deploy_key_full_path:         "/home/{{ deploy_user }}/.ssh/{{ deploy_key_name }}"

# rails vars
rails_env:                    "development"
# NOTE: need to keep in sync with application Gemfile
# TODO: test updating to recent version
rails_version:                "4.2.4"
secret_key_base:              "" # will be generated

# apache vars
apache_remove_welcome:        true
apache_https:                 true
# TODO: only works for CentOS. + needs refactoring
apache_service:               "httpd"
apache_config_file:           "/etc/{{ apache_service }}/conf.d/01_{{ hostname }}.conf"
# NOTE: use this to override the whole apache config template
# apache_config_template:     "templates/apache.conf.j2"
apache_http_redirect_marker:  "http redirect"
# NOTE: uncomment to override apache defaults
# apache_header_mod_marker:     "header modification"
# apache_http_logging_marker:   "http logging"
# apache_https_logging_marker:  "https logging"
# apache_ssl_config_marker:     "ssl config"
# # NOTE: if you use these vars in your logging (or other) local templates,
# # as we do in our examples, you must define the values here,
# # they won't take values defined only in the role
# apache_log_level:             "debug"
# apache_log_path:              "/var/log/{{ apache_service }}"

# passenger vars
# TODO: adopt and move up
update_packages:        false
# NOTE: use this to override the passenger virtualhost sub-template
# passenger_virtualhost_template:     "templates/passenger_virtualhost.j2"

#shib
shib_sp_cert:           "{{ vault_shib_sp_cert }}"
shib_sp_key:            "{{ vault_shib_sp_key }}"
shib_idp_metadata_xml:  "{{ vault_shib_idp_metadata_xml}}"
shib_entity_id:         "blacklight.mse.jhu.edu"
shib_idps:              "{{ vault_shib_idps }}"
# NOTE: overriding because the official repo is having mirror issues at present (9/13/17)
# getting alternate urls from:
# http://download.opensuse.org/repositories/security://shibboleth/CentOS_7/x86_64/shibboleth-2.6.0-2.1.x86_64.rpm.mirrorlist
# because the official list ( https://mirrors.opensuse.org/ )
# is mostly mirrors of the openSUSE project, and not the repos we need
shib_repo_baseurl:      "http://ftp.gwdg.de/pub/opensuse/repositories/security:/shibboleth/CentOS_7/"

# ssh vars
login_group:              "{{ login_user }}"
ssh_groups:               "{{ login_group }}"
ssh_users:                "{{ login_user }}"
ssh_settings:
  - regexp: "^PermitRootLogin"
    setting: "PermitRootLogin no"
  # NOTE: because of the backrefs and the particular construction of the regexp,
  # this rule will only modify the ssh settings if there is already an AllowGroups
  # setting AND the contents of the var ssh_groups is not already in the list.
  # if this is the case, it will add the ssh_groups to the existing list.
  # if there's no such setting (everyone is allowed to ssh), it will have no effect.
  # by mucking with ssh_groups and re-running, it is possible to wind up with redundant entries.
  # i.e. the rule favors not clobbering existing settings over assertiveness or robustness
  - regexp: '^(AllowGroups(?!.*\b{{ ssh_groups }}\b).*)$'
    setting: '\1 {{ ssh_groups }}'
    backrefs: true
  - regexp: '^(AllowUsers(?!.*\b{{ ssh_users }}\b).*)$'
    setting: '\1 {{ ssh_users }}'
    backrefs: true

logrotate_configs:
  - name: "catalyst"
    path: "/opt/catalyst/log"
    # setype: "var_log_t"
    options:
      - "su catalyst catalyst"
      - "daily"
      - "rotate 24"
      - "compress"
      - "delaycompress"
      - "missingok"
